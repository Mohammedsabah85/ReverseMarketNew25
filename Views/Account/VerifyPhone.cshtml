@model VerifyPhoneViewModel
@{
    ViewData["Title"] = "تأكيد رقم الهاتف";
}

<div class="container-custom">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card-custom">
                <div class="text-center mb-4">
                    <i class="fas fa-phone-alt fa-3x text-primary mb-3"></i>
                    <h1 class="h3 text-primary">تأكيد رقم الهاتف</h1>
                    <p class="text-muted">تم إرسال رمز التأكيد إلى رقم:</p>
                    <p class="fw-bold text-primary">@ViewBag.PhoneNumber</p>
                    <p class="text-muted small">تحقق من رسائل واتساب</p>
                </div>

                <form asp-action="VerifyPhone" method="post" id="verifyForm">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-4">
                        <label asp-for="VerificationCode" class="form-label">رمز التأكيد *</label>
                        <input asp-for="VerificationCode" class="form-control text-center fs-4"
                               placeholder="0000" maxlength="4" required style="letter-spacing: 8px;"
                               autocomplete="one-time-code">
                        <span asp-validation-for="VerificationCode" class="text-danger"></span>
                        <div class="form-text">أدخل الرمز المكون من 4 أرقام</div>
                    </div>

                    <button type="submit" class="btn btn-custom w-100" id="verifyBtn">
                        <i class="fas fa-check me-2"></i>
                        تأكيد الرمز والمتابعة
                    </button>
                </form>

                <hr class="my-4">

                <div class="text-center">
                    <p class="text-muted small mb-2">لم تتلق الرمز؟</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-outline-secondary btn-sm" onclick="resendCode()" id="resendBtn">
                            <i class="fas fa-redo me-1"></i>
                            إعادة الإرسال
                        </button>
                        <a href="/Account/Login" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-arrow-right me-1"></i>
                            تغيير الرقم
                        </a>
                    </div>
                    
                    <div id="resendTimer" class="mt-2" style="display: none;">
                        <small class="text-muted">يمكنك إعادة الإرسال خلال <span id="countdown">60</span> ثانية</small>
                    </div>
                </div>

                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="text-primary mb-2">
                        <i class="fas fa-info-circle me-1"></i>
                        الخطوة التالية
                    </h6>
                    <p class="small mb-0">بعد تأكيد رقم الهاتف، ستنتقل لإكمال بيانات حسابك الجديد</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let countdownInterval;
        let countdownTime = 60;

        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('VerificationCode');
            const form = document.getElementById('verifyForm');
            
            // تركيز تلقائي على حقل الإدخال
            input.focus();
            
            // تصفية الإدخال للأرقام فقط
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = value;
                
                // إرسال تلقائي عند إدخال 4 أرقام
                if (value.length === 4) {
                    setTimeout(() => {
                        if (e.target.value.length === 4) {
                            form.submit();
                        }
                    }, 500);
                }
            });

            // بدء العد التنازلي
            startCountdown();
        });

        function resendCode() {
            // تعطيل زر إعادة الإرسال
            const resendBtn = document.getElementById('resendBtn');
            resendBtn.disabled = true;
            resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الإرسال...';

            // إرسال طلب إعادة الإرسال
            fetch('/Account/ResendCode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    // إظهار رسالة نجاح
                    showMessage('تم إعادة إرسال الرمز بنجاح', 'success');
                    
                    // إعادة بدء العد التنازلي
                    countdownTime = 60;
                    startCountdown();
                } else {
                    showMessage('حدث خطأ في إعادة الإرسال', 'error');
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = '<i class="fas fa-redo me-1"></i> إعادة الإرسال';
                }
            })
            .catch(error => {
                showMessage('حدث خطأ في الشبكة', 'error');
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<i class="fas fa-redo me-1"></i> إعادة الإرسال';
            });
        }

        function startCountdown() {
            const resendBtn = document.getElementById('resendBtn');
            const timerDiv = document.getElementById('resendTimer');
            const countdownSpan = document.getElementById('countdown');

            resendBtn.style.display = 'none';
            timerDiv.style.display = 'block';

            countdownInterval = setInterval(() => {
                countdownTime--;
                countdownSpan.textContent = countdownTime;

                if (countdownTime <= 0) {
                    clearInterval(countdownInterval);
                    timerDiv.style.display = 'none';
                    resendBtn.style.display = 'inline-block';
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = '<i class="fas fa-redo me-1"></i> إعادة الإرسال';
                }
            }, 1000);
        }

        function showMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container-custom');
            container.insertBefore(alertDiv, container.firstChild);
            
            // إزالة الرسالة تلقائياً بعد 3 ثوان
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
}